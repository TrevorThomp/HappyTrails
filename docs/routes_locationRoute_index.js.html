<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: routes/locationRoute/index.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: routes/locationRoute/index.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>'use strict';

const express = require('express');
const locationRouter = express.Router();
const superagent = require('superagent');
const Trail = require('../../models/trail');
const Location = require('../../models/location');

locationRouter.get('/location', getLocation)

/**
 * Parses data and creates map markers
 * @param {Array} list 
 * @returns {String} URL of static map markers
 */
function mapMaker(list){
  console.log(list)
  return list.reduce((staticMapURL, object) => {
    if (list.indexOf(object) + 1 !== list.length) staticMapURL += object.latitude.toString() + ',' + object.longitude.toString() + '|';
    else staticMapURL += object.latitude.toString() + ',' + object.longitude.toString() + `&amp;key=${process.env.GEOCODE_API_KEY}`;
    return staticMapURL;
  }, 'https://maps.googleapis.com/maps/api/staticmap?size=1000x1000&amp;maptype=terrain&amp;markers=color:green|');
}

/**
 * Pulls list of trails from the Hiking Project API
 * @param {String} latitude 
 * @param {String} longitude 
 * @param {Number} maxDistance 
 * @returns {Array} Contains list of trails within specified distance
 */
function makeList(latitude,longitude,maxDistance){
  const hikeURL = `https://www.hikingproject.com/data/get-trails?lat=${latitude}&amp;lon=${longitude}&amp;maxDistance=${maxDistance}&amp;maxResults=10&amp;key=${process.env.HIKING_PROJECT_API_KEY}`;
  return superagent.get(hikeURL)
    .then( hikeAPICallResult => {
      return hikeAPICallResult.body.trails.map(trailObject => new Trail(trailObject));
    })
    .catch(err => console.error(err));
}

/**
 * Converts location to latitude/longitude and renders API data into object
 * @param {*} req 
 * @param {*} res 
 * @returns {Object} Contains all API data for EJS rendering
 */
function getLocation(req,res){
  const geocodeUrl = `https://maps.googleapis.com/maps/api/geocode/json?address=${req.query.data}&amp;key=${process.env.GEOCODE_API_KEY}`
  const apiData = {};
  return superagent.get(geocodeUrl)
    .then( result => {
      return new Location(req.query.data, result.body.results[0]);
    })
    .then( location => {
      apiData.location = location;
      return makeList(location.latitude, location.longitude, req.query.maxMiles);
    })
    .then( list => {
      apiData.list = list;
      return mapMaker(list);
    })
    .then( staticMapURL => {
      apiData.staticMapURL = staticMapURL;
      res.render('pages/results', {data: apiData});
    })
    .catch(err => console.error(err));
}

module.exports = locationRouter;</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="Location.html">Location</a></li><li><a href="Trail.html">Trail</a></li></ul><h3>Global</h3><ul><li><a href="global.html#deleteTrail">deleteTrail</a></li><li><a href="global.html#getLocation">getLocation</a></li><li><a href="global.html#getOneTrail">getOneTrail</a></li><li><a href="global.html#getTrails">getTrails</a></li><li><a href="global.html#handleError">handleError</a></li><li><a href="global.html#makeList">makeList</a></li><li><a href="global.html#mapMaker">mapMaker</a></li><li><a href="global.html#saveTrail">saveTrail</a></li><li><a href="global.html#updateTrail">updateTrail</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.3</a> on Thu Apr 02 2020 09:31:23 GMT-0700 (Pacific Daylight Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
